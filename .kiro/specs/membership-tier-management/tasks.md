# 实现计划：会员等级管理

## 概述

本实现计划将会员等级管理功能分解为一系列增量式的编码任务。每个任务都建立在前面的任务之上，最终实现完整的升级和降级功能，包括配置验证、事务支持、幂等性和审计日志。

## 任务

- [x] 1. 扩展核心类型定义
  - 在`src/core/types.ts`中添加新的类型定义
  - 添加`TierCreditsCapConfig`、`UpgradeTierParams`、`DowngradeTierParams`、`TierChangeResult`
  - 扩展`MembershipConfig`接口以包含`creditsCaps`字段
  - _需求: 3.1, 3.2_

- [x] 2. 添加新的错误类型
  - 在`src/core/errors.ts`中添加`InvalidTierChangeError`和`UndefinedTierError`
  - 实现错误类的构造函数和错误消息格式
  - 导出新的错误类型
  - _需求: 1.6, 1.7, 2.6, 2.7_

- [ ] 3. 扩展存储适配器接口
  - [x] 3.1 在`IStorageAdapter`接口中添加`updateUserMembership`方法
    - 定义方法签名，支持同时更新等级、积分和到期时间
    - 添加详细的JSDoc注释
    - _需求: 8.1, 8.2, 8.3_
  
  - [x] 3.2 为存储适配器接口编写单元测试
    - 测试方法签名的正确性
    - _需求: 8.1, 8.2_

- [ ] 4. 实现PrismaAdapter的updateUserMembership方法
  - [x] 4.1 在`PrismaAdapter`中实现`updateUserMembership`方法
    - 使用Prisma的update方法同时更新多个字段
    - 支持事务上下文参数
    - 处理用户不存在的情况
    - _需求: 8.3, 8.4_
  
  - [x] 4.2 为PrismaAdapter.updateUserMembership编写单元测试
    - 测试成功更新场景
    - 测试用户不存在场景
    - 测试事务支持
    - _需求: 8.3, 8.4_

- [ ] 5. 实现MockAdapter的updateUserMembership方法
  - [x] 5.1 在`MockAdapter`中实现`updateUserMembership`方法
    - 更新内存中的用户数据
    - 支持事务模拟
    - 处理用户不存在的情况
    - _需求: 8.3, 8.4_
  
  - [x] 5.2 为MockAdapter.updateUserMembership编写单元测试
    - 测试成功更新场景
    - 测试用户不存在场景
    - _需求: 8.3, 8.4_

- [ ] 6. 增强CreditsEngine配置验证
  - [x] 6.1 在`CreditsEngine.validateConfig`中添加积分上限验证
    - 验证`creditsCaps`字段存在
    - 验证每个等级都有对应的积分上限
    - 验证积分上限为非负数值
    - _需求: 3.2, 3.3, 3.4_
  
  - [x] 6.2 为配置验证编写单元测试
    - 测试缺少creditsCaps的配置
    - 测试缺少特定等级积分上限的配置
    - 测试负数积分上限的配置
    - _需求: 3.2, 3.3, 3.4_
  
  - [x] 6.3 编写配置验证的属性测试
    - **属性 8: 配置验证**
    - **验证需求: 3.2, 3.3, 3.4**

- [ ] 7. 实现upgradeTier方法
  - [x] 7.1 在`CreditsEngine`中实现`upgradeTier`方法的核心逻辑
    - 实现幂等性检查
    - 实现用户验证
    - 实现目标等级验证
    - 实现升级方向验证
    - 实现等级和积分更新
    - 实现交易记录创建
    - 实现审计日志记录
    - 实现幂等记录保存
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8_
  
  - [x] 7.2 为upgradeTier编写单元测试
    - 测试成功升级场景
    - 测试用户不存在场景
    - 测试目标等级不存在场景
    - 测试无效升级方向场景
    - 测试幂等性
    - 测试审计日志创建
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8_
  
  - [x] 7.3 为upgradeTier编写属性测试
    - **属性 1: 等级变更方向验证**（升级部分）
    - **验证需求: 1.1, 1.7**
  
  - [x] 7.4 为upgradeTier编写属性测试
    - **属性 2: 等级字段更新**（升级部分）
    - **验证需求: 1.2**
  
  - [x] 7.5 为upgradeTier编写属性测试
    - **属性 3: 积分上限应用**（升级部分）
    - **验证需求: 1.3**
  
  - [x] 7.6 为upgradeTier编写属性测试
    - **属性 4: 交易记录创建**（升级部分）
    - **验证需求: 1.4**
  
  - [x] 7.7 为upgradeTier编写属性测试
    - **属性 6: 未定义等级错误处理**（升级部分）
    - **验证需求: 1.6**
  
  - [x] 7.8 为upgradeTier编写属性测试
    - **属性 7: 用户不存在错误处理**（升级部分）
    - **验证需求: 1.8**

- [ ] 8. 实现downgradeTier方法
  - [x] 8.1 在`CreditsEngine`中实现`downgradeTier`方法的核心逻辑
    - 实现幂等性检查
    - 实现用户验证
    - 实现目标等级验证
    - 实现降级方向验证
    - 实现等级和积分更新
    - 实现会员到期时间清除逻辑
    - 实现交易记录创建
    - 实现审计日志记录
    - 实现幂等记录保存
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 6.3_
  
  - [x] 8.2 为downgradeTier编写单元测试
    - 测试成功降级场景
    - 测试用户不存在场景
    - 测试目标等级不存在场景
    - 测试无效降级方向场景
    - 测试会员到期时间清除
    - 测试幂等性
    - 测试审计日志创建
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8, 6.3_
  
  - [x] 8.3 为downgradeTier编写属性测试
    - **属性 1: 等级变更方向验证**（降级部分）
    - **验证需求: 2.1, 2.7**
  
  - [x] 8.4 为downgradeTier编写属性测试
    - **属性 2: 等级字段更新**（降级部分）
    - **验证需求: 2.2**
  
  - [x] 8.5 为downgradeTier编写属性测试
    - **属性 3: 积分上限应用**（降级部分）
    - **验证需求: 2.3**
  
  - [x] 8.6 为downgradeTier编写属性测试
    - **属性 4: 交易记录创建**（降级部分）
    - **验证需求: 2.4**
  
  - [x] 8.7 为downgradeTier编写属性测试
    - **属性 6: 未定义等级错误处理**（降级部分）
    - **验证需求: 2.6**
  
  - [x] 8.8 为downgradeTier编写属性测试
    - **属性 7: 用户不存在错误处理**（降级部分）
    - **验证需求: 2.8**

- [ ] 9. 实现会员到期时间管理
  - [x] 9.1 在upgradeTier中添加到期时间更新逻辑
    - 当提供membershipExpiresAt参数时更新到期时间
    - 当未提供时保持现有到期时间
    - _需求: 6.1, 6.2_
  
  - [x] 9.2 为会员到期时间管理编写属性测试
    - **属性 11: 会员到期时间管理**
    - **验证需求: 6.1, 6.2, 6.3**

- [ ] 10. 实现审计日志记录
  - [x] 10.1 为审计日志记录编写属性测试
    - **属性 5: 审计日志记录**
    - 测试成功操作的审计日志
    - 测试失败操作的审计日志
    - 测试审计功能禁用时的行为
    - **验证需求: 7.1, 7.2, 7.3, 7.4, 7.5**

- [ ] 11. 实现事务支持测试
  - [x] 11.1 为事务支持编写属性测试
    - **属性 9: 事务原子性**
    - 测试事务中的操作
    - 测试失败时的回滚
    - 测试数据一致性
    - **验证需求: 4.1, 4.2, 4.3**

- [ ] 12. 实现幂等性支持测试
  - [x] 12.1 为幂等性支持编写属性测试
    - **属性 10: 幂等性保证**
    - 测试重复调用返回缓存结果
    - 测试首次调用执行操作
    - **验证需求: 5.1, 5.2**

- [ ] 13. 实现存储适配器原子更新测试
  - [x] 13.1 为存储适配器原子更新编写属性测试
    - **属性 12: 存储适配器原子更新**
    - 测试等级和积分同时更新
    - 测试用户不存在时的错误处理
    - **验证需求: 8.3, 8.4**

- [ ] 14. 更新导出和文档
  - [x] 14.1 在`src/index.ts`中导出新的类型和错误类
    - 导出`UpgradeTierParams`、`DowngradeTierParams`、`TierChangeResult`
    - 导出`InvalidTierChangeError`、`UndefinedTierError`
    - 导出扩展的`MembershipConfig`类型
    - _需求: 所有_
  
  - [x] 14.2 更新API文档
    - 在`docs/API_REFERENCE.md`中添加`upgradeTier`和`downgradeTier`方法文档
    - 添加新类型和错误的文档
    - 添加使用示例
    - _需求: 所有_
  
  - [x] 14.3 更新配置文档
    - 在`docs/CONFIGURATION.md`中添加`creditsCaps`配置说明
    - 添加配置示例
    - _需求: 3.1, 3.2_

- [ ] 15. 集成测试
  - [x] 15.1 编写端到端集成测试
    - 测试完整的升级流程
    - 测试完整的降级流程
    - 测试与其他SDK功能的集成
    - 测试事务中的多个操作
    - _需求: 所有_

- [x] 16. 最终检查点
  - 确保所有测试通过
  - 确保代码符合项目编码规范
  - 确保文档完整且准确
  - 如有问题请询问用户

## 注意事项

- 每个任务都引用了具体的需求以确保可追溯性
- 检查点任务确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 所有测试任务都是必需的，以确保从一开始就全面覆盖
