# 实施计划: credit-sdk

## 概述

本实施计划将 credit-sdk 的设计转换为可执行的开发任务。SDK 采用 TypeScript 开发，使用适配器模式实现存储层解耦，支持事务透传和企业级特性（幂等性、重试、审计）。

实施策略：
1. 先建立核心类型系统和接口定义
2. 实现特性模块（独立、可测试）
3. 构建 CreditsEngine 核心逻辑
4. 提供 PrismaAdapter 参考实现
5. 创建 MockAdapter 和测试
6. 添加集成示例

## 任务

- [x] 1. 项目初始化和类型定义
  - 创建 TypeScript 项目结构
  - 配置 tsconfig.json（启用严格模式）
  - 定义核心类型（User, Transaction, AuditLog, ChargeParams, ChargeResult 等）
  - 定义 IStorageAdapter 接口
  - 定义 ILogAdapter 接口
  - 定义 CreditsConfig 类型
  - _需求: 1.1, 1.2, 2.1-2.6, 16.1_

- [ ] 2. 错误处理系统
  - [x] 2.1 实现错误类层次结构
    - 创建 CreditsSDKError 基类
    - 实现 InsufficientCreditsError
    - 实现 UserNotFoundError
    - 实现 MembershipRequiredError
    - 实现 IdempotencyKeyConflictError
    - 实现 ConfigurationError
    - 实现 UndefinedActionError
    - _需求: 3.1-3.5_
  
  - [ ]* 2.2 编写错误类的单元测试
    - 测试错误消息格式
    - 测试错误代码
    - 测试错误上下文信息
    - _需求: 3.1-3.5_

- [ ] 3. 特性模块实现
  - [x] 3.1 实现 CostFormula
    - 实现成本计算逻辑
    - 支持会员等级定价
    - 支持默认成本
    - 处理未定义操作错误
    - _需求: 10.1, 10.3, 10.5_
  
  - [ ]* 3.2 编写 CostFormula 的属性测试
    - **属性 16: 成本计算一致性**
    - **验证需求: 10.1, 10.3**
  
  - [ ]* 3.3 编写 CostFormula 的属性测试
    - **属性 17: 未定义操作的错误处理**
    - **验证需求: 10.5**
  
  - [x] 3.4 实现 MembershipValidator
    - 实现会员等级验证
    - 实现过期检查
    - 支持等级层次结构
    - _需求: 11.1-11.4_
  
  - [ ]* 3.5 编写 MembershipValidator 的属性测试
    - **属性 4: 会员权限验证**
    - **验证需求: 3.3, 9.1, 9.2**
  
  - [x] 3.6 实现 IdempotencyManager
    - 实现幂等键检查
    - 实现结果缓存
    - 实现 TTL 过期处理
    - _需求: 12.1-12.5_
  
  - [ ]* 3.7 编写 IdempotencyManager 的属性测试
    - **属性 18: 幂等记录过期**
    - **验证需求: 12.5**
  
  - [x] 3.8 实现 AuditTrail
    - 实现日志记录方法
    - 支持结构化元数据
    - 通过 StorageAdapter 持久化
    - _需求: 14.1-14.5_
  
  - [ ]* 3.9 编写 AuditTrail 的属性测试
    - **属性 21: 审计日志完整性**
    - **验证需求: 14.1, 14.2**
  
  - [x] 3.10 实现 RetryHandler
    - 实现重试逻辑
    - 实现指数退避
    - 支持可配置重试策略
    - 识别可重试错误
    - _需求: 13.1-13.5_
  
  - [ ]* 3.11 编写 RetryHandler 的属性测试
    - **属性 19: 瞬态错误自动重试**
    - **验证需求: 13.1, 13.2**
  
  - [ ]* 3.12 编写 RetryHandler 的属性测试
    - **属性 20: 指数退避**
    - **验证需求: 13.3**

- [x] 4. 检查点 - 确保特性模块测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 5. CreditsEngine 核心实现
  - [x] 5.1 实现 CreditsEngine 构造函数和配置
    - 接受 storage adapter 和 config
    - 初始化特性模块
    - 设置日志记录器
    - _需求: 17.1-17.5_
  
  - [x] 5.2 实现 charge 方法
    - 实现完整的扣费流程
    - 集成幂等性检查
    - 集成会员验证
    - 集成成本计算
    - 集成余额检查
    - 集成审计日志
    - 支持事务透传
    - _需求: 4.1-4.5_
  
  - [x] 5.3 编写 charge 的属性测试
    - **属性 2: 余额不足时拒绝扣费**
    - **验证需求: 3.1**
  
  - [-] 5.4 编写 charge 的属性测试
    - **属性 5: 扣费操作完整性**
    - **验证需求: 4.1, 4.4**
  
  - [~] 5.5 编写 charge 的属性测试
    - **属性 6: 幂等性保证**
    - **验证需求: 4.2**
  
  - [x] 5.6 实现 refund 方法
    - 实现退款流程
    - 创建交易记录（正金额）
    - 创建审计日志
    - 支持幂等性
    - 支持事务透传
    - _需求: 5.1-5.5_
  
  - [~] 5.7 编写 refund 的属性测试
    - **属性 8: 退款增加余额**
    - **验证需求: 5.1, 5.2**
  
  - [x] 5.8 实现 grant 方法
    - 实现发放流程
    - 验证金额为正数
    - 创建交易记录
    - 创建审计日志
    - 支持事务透传
    - _需求: 6.1-6.5_
  
  - [~] 5.9 编写 grant 的属性测试
    - **属性 9: 发放积分增加余额**
    - **验证需求: 6.1, 6.2, 6.3**
  
  - [~] 5.10 编写 grant 的属性测试
    - **属性 10: 发放金额验证**
    - **验证需求: 6.5**
  
  - [x] 5.11 实现 queryBalance 方法
    - 查询用户余额
    - 处理用户不存在错误
    - 支持事务透传
    - _需求: 7.1-7.4_
  
  - [~] 5.12 编写 queryBalance 的属性测试
    - **属性 11: 余额查询准确性**
    - **验证需求: 7.1**
  
  - [~] 5.13 编写 queryBalance 的属性测试
    - **属性 3: 不存在用户的错误处理**
    - **验证需求: 3.2, 7.2**
  
  - [x] 5.14 实现 getHistory 方法
    - 查询交易历史
    - 支持分页（limit, offset）
    - 支持日期范围过滤
    - 支持操作类型过滤
    - 按时间戳降序排序
    - _需求: 8.1-8.5_
  
  - [~] 5.15 编写 getHistory 的属性测试
    - **属性 12: 交易历史查询**
    - **验证需求: 8.1, 8.5**
  
  - [~] 5.16 编写 getHistory 的属性测试
    - **属性 13: 分页正确性**
    - **验证需求: 8.2**
  
  - [~] 5.17 编写 getHistory 的属性测试
    - **属性 14: 日期范围过滤**
    - **验证需求: 8.3**
  
  - [~] 5.18 编写 getHistory 的属性测试
    - **属性 15: 操作类型过滤**
    - **验证需求: 8.4**
  
  - [x] 5.19 实现 validateAccess 方法
    - 验证会员权限
    - 检查会员过期
    - 抛出适当错误
    - _需求: 9.1-9.5_
  
  - [~] 5.20 编写 validateAccess 的单元测试
    - 测试各种会员等级组合
    - 测试过期场景
    - _需求: 9.1-9.5_

- [x] 6. 检查点 - 确保核心引擎测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 7. 日志系统实现
  - [x] 7.1 实现 ConsoleLogger
    - 实现 ILogAdapter 接口
    - 使用 console 方法
    - _需求: 16.2_
  
  - [x] 7.2 集成日志到 CreditsEngine
    - 在关键操作点添加日志
    - 包含上下文信息
    - _需求: 16.4, 16.5_
  
  - [~] 7.3 编写日志系统的属性测试
    - **属性 23: 日志记录完整性**
    - **验证需求: 16.4, 16.5**

- [ ] 8. PrismaAdapter 参考实现
  - [x] 8.1 创建 Prisma schema
    - 定义 User 模型
    - 定义 Transaction 模型
    - 定义 AuditLog 模型
    - 定义 IdempotencyRecord 模型
    - _需求: 15.1_
  
  - [x] 8.2 实现 PrismaAdapter
    - 实现所有 IStorageAdapter 方法
    - 正确处理事务上下文
    - 映射类型
    - 转换错误
    - _需求: 15.1-15.5_
  
  - [~] 8.3 编写 PrismaAdapter 的属性测试
    - **属性 7: 事务透传**
    - **验证需求: 4.5, 5.5, 6.4, 7.3, 15.2**
  
  - [~] 8.4 编写 PrismaAdapter 的属性测试
    - **属性 22: Prisma 错误转换**
    - **验证需求: 15.5**
  
  - [ ]* 8.5 编写 PrismaAdapter 的集成测试
    - 使用真实数据库测试
    - 测试事务场景
    - 测试并发操作
    - _需求: 15.1-15.5_

- [ ] 9. MockAdapter 测试工具
  - [x] 9.1 实现 MockAdapter
    - 使用内存存储
    - 实现所有 IStorageAdapter 方法
    - 支持事务模拟
    - 提供测试辅助方法
    - _需求: 19.1-19.4_
  
  - [ ]* 9.2 编写 MockAdapter 的单元测试
    - 测试所有方法
    - 测试事务模拟
    - _需求: 19.2-19.3_

- [ ] 10. 事务和并发测试
  - [~] 10.1 编写事务原子性的属性测试
    - **属性 1: 事务原子性**
    - **验证需求: 1.3, 4.3**
  
  - [~] 10.2 编写并发操作测试
    - 测试多个并发 charge 操作
    - 测试竞态条件
    - 验证数据一致性

- [ ] 11. 集成示例
  - [~] 11.1 创建 Next.js 集成示例
    - 设置 Next.js 项目
    - 配置 CreditsEngine
    - 实现 Server Actions
    - 演示完整流程
    - _需求: 20.1_
  
  - [~] 11.2 创建 Express.js 集成示例
    - 设置 Express 项目
    - 配置 CreditsEngine
    - 实现 REST 端点
    - 演示完整流程
    - _需求: 20.2_
  
  - [~] 11.3 创建自定义适配器模板
    - 提供适配器接口实现模板
    - 包含注释和最佳实践
    - _需求: 20.3_
  
  - [~] 11.4 创建配置示例
    - 提供常见场景的配置
    - 包含成本配置示例
    - 包含会员配置示例
    - _需求: 20.4_

- [ ] 12. 文档和 JSDoc
  - [x] 12.1 为所有公共 API 添加 JSDoc 注释
    - CreditsEngine 方法
    - IStorageAdapter 接口
    - 所有类型定义
    - 特性模块
    - _需求: 18.5_
  
  - [x] 12.2 创建 README.md
    - 项目介绍
    - 快速开始
    - API 文档
    - 集成指南
    - _需求: 20.5_
  
  - [x] 12.3 创建适配器实现指南
    - 如何实现自定义适配器
    - 最佳实践
    - 常见陷阱
    - _需求: 20.3_

- [x] 13. 最终检查点 - 完整性验证
  - 确保所有测试通过
  - 验证 TypeScript 严格模式编译
  - 检查测试覆盖率
  - 运行集成示例
  - 如有问题请询问用户

## 注意事项

- 标记 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
